job 'stage-0-premerge' do

  description 'the first stage in the pipeline
designed to complete quickly, < 10 mins
produces and publishes a versioned deployment package'

  configure_common_items{}

  assigned_node_string 'amazon_linux'

  concurrent_build true

  triggers do
    pull_request_builder do
      trigger_phrase 'ecosystem-premerge-test'
      commit_status_context 'ecosystem-premerge-test'
    end
  end

  build_wrappers do
    secret_text do
      credentialsId 'Workstation'
      variable 'SRCCLR_API_TOKEN'
    end
  end

  builders do
    bash do
      script '#!/usr/bin/env bash
set +xe
export PATH=/usr/local/sbin:/usr/local/bin:$PATH
export WORKSPACE_SETTING=dev
export DEBUG=0
export SRCCLR_SCOPE=production
export SRCCLR_SCAN_COLLECTORS=npm

source .ecosystem
rake veracode
rake build
'
    end
  end
end